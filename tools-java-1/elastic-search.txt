elastic search

What is an elastic search?

-	Elastic search is a tool built for high speed search and scalability.

-	It exposes all its features as REST endpoints.

-	It accepts incoming request on port 9200.

-	It uses port 9300 for inter-node communication.

What is Kibana?

-	Kibana is data visualisation and management tool designed to interact with elastic search.

-	It exposes port 5601.

Enlist health related REST endpoints exposed by elastic search?

-	Below are different health related REST endpoints exposed by elastic search,

	Method				Endpoint						Body		Description
	-------------------------------------------------------------------------------			
-	GET					/_cluster/health							This endpoint is used to return the overall health status of the 
																	elastic search cluster.
			
-	GET					/_nodes										This endpoint is used to return the information about all nodes.
				
-	GET					/cat/{endpoint}?v							This endpoint is used to return the compact response of other endpoints.
																	The parameter v includes headers inside the response.

What is an index?

-	Index is an fundamental unit of storage inside elastic search.

-	It is analogous to table inside RDBMS.

-	It is a collection of documents.

-	Below are the REST endpoints exposed by elastic search to create an index,

	Method				Endpoint						Body		Description
	-------------------------------------------------------------------------------			
-	PUT					/{name}							empty		This endpoint is used to create index with supplied name.

																	Example:
																	
																	PUT /books

-	Below are the REST endpoints exposed by elastic search to query indices,

	Method				Endpoint						Body		Description
	-------------------------------------------------------------------------------			
-	GET					/_cat/indices?v								This endpoint is used to return all indices available inside elastic search.
			
-	GET					/_cat/indices/{name|regex}?v				This endpoint is used to return indices with supplied name.
														
-	Below are the REST endpoints exposed by elastic search to delete and index,

	Method				Endpoint						Body		Description
	-------------------------------------------------------------------------------			
-	DELTE				/{name}							empty		This endpoint is used to delete index with supplied name.
																	
																	Example:
																	
																	DELTE /books
What is a document?

-	A document is a fundamental unit of information inside elastic search.

-	It is analogous to row inside RDBMS.

-	Below are the REST endpoints exposed by elastic search to create a document,

	Method				Endpoint						Body		Description
	-------------------------------------------------------------------------------			
-	POST				/{name}/_doc					{document}	This endpoint is used to create document inside index with supplied name.

																	Example:

																	POST /books/_doc
																	{
																		"title": "The Great Gatsby",
																		"author": "F. Scott Fitzgerald",
																		"year": 1926,
																		"genre": "Fiction",
																		"rating": 4.7
																	}

-	Every document is embedded inside a parent document inside field called as _source.

-	Elastic search by default adds unique identifier with field called as _id to each document.

-	However we can override the default identifier by providing custom identifier using below REST endpoint,

	Method				Endpoint						Body		Description
	-------------------------------------------------------------------------------			
-	POST				/{name}/_doc/{id}				{document}	This endpoint is used to create document with supplied id inside index with supplied name.

																	Example:

																	POST /books/_doc/3
																	{
																		"title": "The Great Gatsby",
																		"author": "F. Scott Fitzgerald",
																		"year": 1926,
																		"genre": "Fiction",
																		"rating": 4.7
																	}																				

-	Below are the REST endpoints exposed by elastic search to query a document,
	
	Method				Endpoint						Body		Description
	-------------------------------------------------------------------------------
-	GET					/{name}/_search								This endpoint is used to return all documents inside index with supplied name.
			
-	GET					/{name}/_search?q={name|regex}				This endpoint is used to return all documents with any field matching supplied name 
																	or regex inside index with supplied name.

-	GET					/{name}/_doc/{id}							This endpoint is used to return document with supplied id inside index with supplied name.

-	Below are the REST endpoints exposed by elastic search to query a document,

	Method				Endpoint						Body		Description
	-------------------------------------------------------------------------------			
-	PUT|POST			/{name}/_doc/{id}				{document}	This endpoint is used to create document with supplied id if it doesn't exists or update 
																	an existing document if it exists inside index with supplied name.

																	Example:

																	PUT /books/_doc/3
																	{
																		"title": "The Great Gatsby",
																		"author": "F. Scott Fitzgerald",
																		"year": 1976,
																		"genre": "Fiction",
																		"rating": 4.7
																	}

-	POST				/{name}/_update/{id}			{delta}		This endpoint is used to update document with supplied id inside index with supplied name.
																	
																	When the id doesn't exists then the response returns exception document_missing_exception.				

																	Example:

																	POST /books/_update/3
																	{
																		"doc": {
																			"year": 1976
																		}
																	}

																	We can add an additional field "doc_as_upsert" : true to create document with supplied id
																	if it doesn't exists.

-	Below are the REST endpoints exposed by elastic search to delete a document,

	Method				Endpoint						Body		Description
	-------------------------------------------------------------------------------			
-	DELETE				/{name}/_doc/{id}				empty		This endpoint is used to delete document with supplied id if it exists inside index with supplied name.

Explain scripted update?

-	A scripted update is an update to a document based on its existing field.

-	Below are the REST endpoints exposed by elastic search to scripted update a document,

	Method				Endpoint						Body		Description
	-------------------------------------------------------------------------------			
-	POST				/{name}/_doc/{id}				{document}	This endpoint is used to update a document with supplied id inside index with supplied name.

																	Example: Regular update

																	POST /books/_update/3
																	{
																		"script": {
																			"source": "ctx._source.price = ctx._source.price + 100" 
																		}
																	}
																	
																	Example: Parameterised update
																
																	POST /books/_update/3
																	{
																		"script": {
																			"source": "ctx._source.price = params.price + 100",
																			"params": {
																				"price": 100
																			}	
																		}
																	}
																	
																	Example: Conditional update
																
																	POST /books/_update/3
																	{
																		"script": {
																			"source": """
																				if(ctx._source.year <= 1970) {
																					ctx._source.price = ctx._source.price + 100
																				} else {
																					ctx._source.price = ctx._source.price + 200
																				}
																			"""
																		}
																	}

-	Scripted update doesn't need query before update therefore it reduces number of network calls.

-	Its ideal of simple calculation and string manipulation.

-	However scripted update is a string which needs to be evaluated by elastic search therefore causing performance overhead.

How does elastic search work?

-	Apache Lucene is a java library which performs storage, indexing and search.

-	Elastic search uses Apache Lucene.

-	It is a distributed server exposing REST endpoints on top of Apache Lucene.

-	When a document is saved inside elastic search, it parses the document.

-	From the parsed result it extracts tokens.

-	These tokens are saved inside a table called inverted index, along with the token name, document identifier and position.

-	Consider below REST endpoints are requested,

	Example:
	
	POST products/_doc/1 {
		"name": "Apple iphone 13"
	}
		
	POST products/_doc/2 {
		"name": "Samsung galaxy S21"
	}
		
	POST products/_doc/3 {
		"name": "Apple macbook"
	}
	
-	Now elastic search will parse the document, extract tokens and save them in below format.

	Token					Document				Position
	--------------------------------------------------------
	Apple					1,3						[0],[0]
	iphone					1						[1]
	13						1						[2]
	Samsung					2						[0]
	...						...						...			
	macbook					3						[1]	
	
-	When a search query is made then elastic search tokenises the query parameters.

-	Then it searches for the tokens inside the inverted index.

-	When found it reads the document identifier, then it query the document from the index and return it.

Explain term frequency and document frequency?

-	The term frequency refers to number of times a token repeats inside an document.

-	The document frequency refers to number of documents having the token inside them.

-	Consider below documents are requested,

	Example:
	
	{
		"text": "Sam likes coffee. He always starts his day with coffee. A strong coffee can keep you awake."
	}
		
	{
		"name": "Some prefer tea over coffee."
	}
	
-	Inside the inverted index the above information is saved inside two tables called term dictionary and posting list.

			Term Dictionary													Posting List	

	Token			Document Frequency						Token			Document Id			Position	
	----------------------------------						--------------------------------------------		
	coffee			2-------------------------------------->3/17			1					[2,9,12]
	tea				1								|------>1/5				2					[4]
					|-------------------------------------->1/5				2					[2]	
					
-	Inside Posting List table the Token column represents number of times a token repeats out of total number of tokens inside a document.

What is segment?

-	A single index is divided into multiple parts called as segment.

-	It is immutable.

-	It is a collection of one or more files containing the documents.

-	Each segment is also an index.

-	It will have its own inverted index.

-	When a new document is saved, it is first inserted inside memory buffer.

-	Then periodically from the memory buffer all the documents are flushed to disk as a segment.

-	This improves write performance, but increases the overhead of search operation.

-	However Apache Lucene periodically merges multiple smaller segments into single larger segment.

-	When a segment is requested to be deleted then it doesn't execute immediately, instead the segment file is marked to be deleted first.

-	The marked segment file is ignored because of the deletion mark from result of every next search request.

-	Later during periodic merge the segment file will be erased permanantly.

-	A segment being immutable is never updated, instead its deleted and reinserted.

Explain the refresh REST endpoint?

-	When a new document is saved, it is first inserted inside memory buffer.

-	Then periodically from the memory buffer all the documents are flushed to disk as a segment.

-	However using below REST endpoint we can forcefully flush the documents from memory buffer to disk immediately.

	Method				Endpoint						Body		Description
	-------------------------------------------------------------------------------			
-	POST				/{name}/_refresh				empty		This endpoint is used to forcefully flush the documents from memory buffer to disk immediately.



